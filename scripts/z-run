#!/dev/null




::// *

::// do / run / ...
::// do / use / ...

::// go / ...

::// deploy / ...
::// workspace / ...




<< deploy / local
	test "${#}" -eq 0
	"${ZRUN[@]}" ':: go / build / main / release'
	_timestamp="$( exec -- date -- '+%Y-%m-%d-%H-%M-%S' )"
	cp -f -- ./.outputs/z-run--release "${HOME}/.bin/z-run--${_timestamp}"
	ln -s -f -- "./z-run--${_timestamp}" "${HOME}/.bin/z-run--0000"
!!


<< deploy / remote / linux
	test "${#}" -eq 1
	_target="${1}"
	shift -- 1
	"${ZRUN[@]}" ':: go / build / main / release / linux'
	rsync -i -t -p --chmod=0555 -- ./.outputs/z-run--release--linux "${_target}"
!!

<< deploy / remote / darwin
	test "${#}" -eq 1
	_target="${1}"
	shift -- 1
	"${ZRUN[@]}" ':: go / build / main / release / darwin'
	rsync -i -t -p --chmod=0555 -- ./.outputs/z-run--release--darwin "${_target}"
!!


<< deploy / publish
	test "${#}" -eq 0
	test -d ./.publish/
	"${ZRUN[@]}" ':: go / build / main / release / linux'
	"${ZRUN[@]}" ':: go / build / main / release / darwin'
	_timestamp="$( exec -- date -- '+%Y-%m-%d-%H-%M-%S' )"
	rsync -i -t -p --chmod=0555 -- ./.outputs/z-run--release--linux "./.publish/linux/z-run--${_timestamp}"
	rsync -i -t -p --chmod=0555 -- ./.outputs/z-run--release--darwin "./.publish/darwin/z-run--${_timestamp}"
	ln -s -T -f -- "./z-run--${_timestamp}" ./.publish/linux/z-run
	ln -s -T -f -- "./z-run--${_timestamp}" ./.publish/darwin/z-run
!!




--<< do / run / 0
	"${ZRUN[@]}" ':: go / build / main / debug'
	test "${#}" -ge 1
	export -n -- \
			ZRUN_LIBRARY_SOURCE= \
			ZRUN_LIBRARY_CACHE= \
			ZRUN_FINGERPRINT= \
			ZRUN_EXECUTABLE= \
			ZRUN_CACHE= \
			ZRUN_TERM= \
	#
	if test -n "${ZRUNDEV_USE:-}" ; then
		export -- ZRUN_LIBRARY_SOURCE="${ZRUNDEV_USE}"
	else
		export -- ZRUN_LIBRARY_SOURCE="./examples/syntax.z-run"
	fi
	export -n -- ZRUNDEV_USE=
	if test -n "${ZRUNDEV_TERM:-}" ; then
		export -- TERM="${ZRUNDEV_TERM}"
	fi
	export -n -- ZRUNDEV_TERM=
	exec -a "${1:-./.outputs/z-run--debug}" -- ./.outputs/z-run--debug "${@:2}"
!!

<< do / run
	exec -- "${ZRUN[@]}" ':: do / run / 0' '' "${@}"
!!


:: do / run / execute :: exec -- "${ZRUN[@]}" ':: do / run' execute-scriptlet "${@}"
:: do / run / select-label :: exec -- "${ZRUN[@]}" ':: do / run' select-export-scriptlet-label "${@}"
:: do / run / select-body :: exec -- "${ZRUN[@]}" ':: do / run' select-export-scriptlet-body "${@}"
:: do / run / list-labels :: exec -- "${ZRUN[@]}" ':: do / run' export-scriptlet-labels "${@}"
:: do / run / parse-library :: exec -- "${ZRUN[@]}" ':: do / run' parse-library "${@}"
:: do / run / export-library-json :: exec -- "${ZRUN[@]}" ':: do / run' export-library-json "${@}"
:: do / run / export-library-cdb :: exec -- "${ZRUN[@]}" ':: do / run' export-library-cdb "${@}"
:: do / run / select :: exec -- "${ZRUN[@]}" ':: do / run / 0' '[z-run:select]' "${@}"


:: do / use / workspace :: export -- ZRUNDEV_USE=./.z-run
:: do / use / syntax :: export -- ZRUNDEV_USE=./examples/syntax.z-run

:: do / use / term / enable :: export -- ZRUNDEV_TERM="${TERM}"
:: do / use / term / disable :: export -- ZRUNDEV_TERM=dumb




<< go / build / main / debug
	test "${#}" -eq 0
	_outputs="$( exec -- readlink -e -- ./.outputs )"
	exec -- "${ZRUN[@]}" ':: go / tool' \
			build \
			-v \
			-o "${_outputs}/z-run--debug" \
			-- \
			./cmd/z-run.go \
	#
!!

<< go / build / main / release
	test "${#}" -eq 0
	_outputs="$( exec -- readlink -e -- ./.outputs )"
	if test -n "${GOOS:-}" ; then
		_suffix="--${GOOS}"
	else
		_suffix=''
	fi
	exec -- "${ZRUN[@]}" ':: go / tool' \
			build \
			-v \
			-o "${_outputs}/z-run--release${_suffix}" \
			-ldflags '-s' \
			-- \
			./cmd/z-run.go \
	#
!!

<< go / build / main / release / linux
	export -- GOOS=linux
	"${ZRUN[@]}" ':: go / build / main / release'
!!

<< go / build / main / release / darwin
	export -- GOOS=darwin
	"${ZRUN[@]}" ':: go / build / main / release'
!!




<< go / execute / main / debug
	"${ZRUN[@]}" ':: go / build / main / debug'
	exec -- ./.outputs/z-run--debug "${@}"
!!

<< go / execute / main / release
	"${ZRUN[@]}" ':: go / build / main / release'
	exec -- ./.outputs/z-run--release "${@}"
!!




<< go / dependencies / update
	test "${#}" -eq 0
	exec -- "${ZRUN[@]}" ':: go / tool' \
			get \
			-v \
			-d \
			-u \
			-- \
			all \
	#
!!


<< go / dependencies / list
	test "${#}" -eq 0
	exec -- "${ZRUN[@]}" ':: go / tool' \
			list \
			-m \
			-- \
			all \
	#
!!


<< go / dependencies / tidy
	test "${#}" -eq 0
	exec -- "${ZRUN[@]}" ':: go / tool' \
			mod tidy \
	#
!!




<< go / tool
	test "${#}" -ge 1
	_outputs="$( exec -- readlink -e -- ./.outputs )"
	_sources="$( exec -- readlink -e -- ./sources )"
	
	export -- GOPATH="${_outputs}/go"
	export -- GOBIN="${_outputs}/go/bin"
	export -- GOTMPDIR="${_outputs}/go/tmp"
	export -- GOCACHE="${_outputs}/go/cache"
	
	cd -- "${_sources}"
	
	exec -- go "${@}"
!!




<< workspace / initialize / go
	test "${#}" -eq 0
	_outputs="$( exec -- readlink -e -- ./.outputs )"
	_sources="$( exec -- readlink -e -- ./sources )"
	
	GOPATH="${_outputs}/go"
	GOBIN="${_outputs}/go/bin"
	GOTMPDIR="${_outputs}/go/tmp"
	GOCACHE="${_outputs}/go/cache"
	_gosrc="${_outputs}/go/src"
	_gopkg="${_outputs}/go/pkg"
	
	for _folder in "${GOPATH}" "${GOBIN}" "${GOTMPDIR}" "${GOTMPDIR}" "${GOCACHE}" "${_gosrc}" "${_gopkg}" ; do
		if test ! -e "${_folder}" ; then
			mkdir -- "${_folder}"
		fi
	done
!!




<< workspace / initialize / outputs
	test "${#}" -eq 0
	if test ! -d ./.outputs ; then
		_outputs_store="${TMPDIR:-/tmp}/go--${UID}--${RANDOM}-${RANDOM}-${RANDOM}-${RANDOM}"
		mkdir -- "${_outputs_store}"
		_outputs_store="$( exec -- readlink -e -- "${_outputs_store}" )"
		ln -s -f -T -- "${_outputs_store}" ./.outputs
	fi
!!




<< workspace / sources / codes / duplicates
	test "${#}" -eq 0
	exec -- xargs \
			-r -d '\n' -I {} \
			-a <(
				grep \
						-o \
						-P \
						-e '(?<=\[)[0-9a-f]{8}(?=\])|(?<=0x)[0-9a-f]{8}(?=[^0-9a-zA-Z]|$)' \
						-h \
						-r ./sources \
						--include '*.go' \
				| sort \
				| uniq -d
			) \
			-- \
		grep \
			-P \
			-e '(?<=\[){}(?=\])|(?<=0x){}(?=[^0-9a-zA-Z]|$)' \
			-r ./sources \
			-n \
			--include '*.go' \
			--color \
	#
!!

